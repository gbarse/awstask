version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17
    commands:
      - echo "Installing SAM CLI â€¦"
      - pip install aws-sam-cli
  pre_build:
    commands:
      - echo "ðŸ”  Logging in to ECR"
      - aws ecr get-login-password --region us-east-2 \
        | docker login --username AWS --password-stdin 151182332702.dkr.ecr.us-east-2.amazonaws.com
  build:
    commands:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Build + tag the DOCKER image exactly as you do locally â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - echo "ðŸ³  Building Docker image"
      - docker build -t gorb/aws-task .
      - docker tag gorb/aws-task:latest 151182332702.dkr.ecr.us-east-2.amazonaws.com/gorb/aws-task:latest

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Package the SAM template for Lambda (unchanged) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - echo "â˜ï¸  Building Lambda SAM package"
      - mvn -q clean package
      - sam package                                   \
          --template-file templateSAM.yml             \
          --s3-bucket gor-barseghyan-site             \
          --output-template-file packaged.yml
  post_build:
    commands:
      - echo "ðŸ“¤  Pushing image to ECR"
      - docker push 151182332702.dkr.ecr.us-east-2.amazonaws.com/gorb/aws-task:latest

      # imagedefinitions.json must use the **container name** thatâ€™s in your task-def
      # (looks like â€œGorB-image-appâ€).  If you named the container differently,
      # change the value of name accordingly.
      - echo "ðŸ“  Creating imagedefinitions.json"
      - printf '[{"name":"GorB-image-app","imageUri":"151182332702.dkr.ecr.us-east-2.amazonaws.com/gorb/aws-task:latest"}]' \
        > imagedefinitions.json

artifacts:
  secondary-artifacts:
    ecsArtifact:
      files:
        - imagedefinitions.json
    lambdaArtifact:
      files:
        - packaged.yml
